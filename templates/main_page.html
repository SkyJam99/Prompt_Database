<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Prompt Database</title>
        <meta charset="UTF-8">
        <meta name="author" content="Riley Meyers">
        <meta name="last modified" content="28/01/2024">
        <meta name="viewport" content="width=device-width, initial-scale=1">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="https://code.jquery.com/jquery-3.7.0.js"></script>

    </head>

    <body>
        <div class="bg-dark text-light">
            <div class="container-fluid text-center">
                <div class="row">
                    <div class="col-sm-12">
                        <h1>Prompt Database</h1>



                    </div>
                </div>
            </div>

            <!-- Buttons for showing and hiding each of the sections below (Search by ID, Create Prompt, Delete Prompt, and Update Prompt)-->

            <div class="container">
                <div class="row p-5">
                    <div class="col-sm">
                        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#searchByIdSection" aria-expanded="false" aria-controls="searchById">Search by ID</button>
                    </div>
                    <div class="col-sm">
                        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#createPromptSection" aria-expanded="false" aria-controls="createPrompt">Create Prompt</button>
                    </div>
                    <div class="col-sm">
                        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#deletePromptSection" aria-expanded="false" aria-controls="deletePrompt">Delete Prompt</button>
                    </div>
                    <div class="col-sm">
                        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#updatePromptSection" aria-expanded="false" aria-controls="updatePrompt">Update Prompt</button>
                    </div>
            </div>

            

            

            <!-- Search for prompt by id -->
            <div class="container collapse" id="searchByIdSection">
                <div class="row p-5">

                    <div class="col-sm">
                        <label for="searchId">Search by ID</label>
                        <input type="text" class="form-control" id="searchId" name="search_id" placeholder="Enter ID">
                    </div>

                    <div class="col-sm">
                        <button type="button" class="btn btn-primary" id="searchButton">Search</button>
                    </div>

                </div>
            </div>

            <script>
                $(document).ready(function() {
                    $('#searchButton').click(function() {
                        let searchId = $('#searchId').val();

                        //input validation using regex (id can a number between 1 and 999999)
                        if (!/^[1-9]\d{0,5}$/.test(searchId)) {
                            alert("Please enter a valid ID (1-999999)");
                            return;
                        }

                        $.ajax({
                            url: '/prompt/' + searchId,
                            type: 'GET',
                            success: function(data) {
                                console.log('Success:', data);
                                let promptHtml = jsonToHtmlTable(data);
                                $('#results').html(promptHtml);
                            },
                            error: function(xhr, status, error) {
                                $('#results').html("Error: " + error);
                            }
                        });
                    });
                });
            </script>

            <!-- Add new prompt form will be called by a jQuery POST Request -->
            <!-- Prompt database JSON format (need to collect data for each of these fields except id. parent_prompt_id is not included right now, will be included when inheriting a prompt):
            # {
            #     "id": int,
            #     "name": string,
            #     "prompt_content": string,
            #     "prompt_variables": string,
            #     "designed_for": string,
            #     "parent_prompt_id": int
            #}
            -->
            <div class="container collapse" id="createPromptSection">
                <div class="row">


                        <div class="col-sm">
                            <label for="name">Name</label>
                            <input type="text" class="form-control" id="name" name="name" placeholder="Enter name">
                        </div>

                        <div class="col-sm">
                            <label for="promptContent">Prompt Content</label>
                            <textarea class="form-control" id="promptContent" name="prompt_content" rows="1" placeholder="Enter prompt content"></textarea>
                        </div>

                        <div class="col-sm">
                            <label for="promptVariables">Prompt Variables</label>
                            <input type="text" class="form-control" id="promptVariables" name="prompt_variables" placeholder="Enter prompt variables">
                        </div>

                        <div class="col-sm">
                            <label for="designedFor">Designed For</label>
                            <input type="text" class="form-control" id="designedFor" name="designed_for" placeholder="Enter designed for">
                        </div>

                        <div class="col-sm">
                            <button type="button" class="btn btn-primary" id="createButton">Submit</button>
                        </div>


                </div>
            </div>

            <script>
                $(document).ready(function() {
                    $('#createButton').click(function() {
                        //input validation
                        let formName = $('#name').val();
                        let formPromptContent = $('#promptContent').val();
                        let formPromptVariables = $('#promptVariables').val();
                        let formDesignedFor = $('#designedFor').val();

                        if (formName === "" || formPromptContent === "" || formPromptVariables === "" || formDesignedFor === "") {
                            alert("Please fill out all fields to create prompt");
                            return;
                        }

                        let formData = {
                            name: formName,
                            prompt_content: formPromptContent,
                            prompt_variables: formPromptVariables,
                            designed_for: formDesignedFor
                        };


                        $.ajax({
                            url: '/prompt',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(formData),
                            dataType: 'json',
                            success: function(data) {
                                console.log('Success:', data);
                                alert('Prompt added successfully');
                            },
                            error: function(xhr, status, error) {
                                $('#results').html("Error: " + error);
                            }
                        });
                    });
                });
            </script>

            <!-- Delete prompt by id -->
            <div class="container collapse" id="deletePromptSection">
                <div class="row p-5">

                    <div class="col-sm">
                        <label for="deleteId">Delete by ID</label>
                        <input type="text" class="form-control" id="deleteId" name="delete_id" placeholder="Enter ID">
                    </div>

                    <div class="col-sm">
                        <button type="button" class="btn btn-primary" id="deleteButton">Delete</button>
                    </div>

                </div>
            </div>

            <script>
                $(document).ready(function() {
                    $('#deleteButton').click(function() {
                        let deleteId = $('#deleteId').val();

                        //input validation using regex (id can a number between 1 and 999999)
                        if (!/^[1-9]\d{0,5}$/.test(deleteId)) {
                            alert("Please enter a valid ID (1-999999)");
                            return;
                        }

                        $.ajax({
                            url: '/prompt/' + deleteId,
                            type: 'DELETE',
                            success: function(data) {
                                console.log('Success:', data);
                                alert('Prompt deleted successfully');
                            },
                            error: function(xhr, status, error) {
                                $('#results').html("Error: " + error);
                            }
                        });
                    });
                });
            </script>


            <!-- Update prompt by id -->
            <div class="container collapse" id="updatePromptSection">
                <div class="row p-5">

                    <div class="col-sm">
                        <label for="updateId">Update by ID</label>
                        <input type="text" class="form-control" id="updateId" name="update_id" placeholder="Enter ID">
                    </div>

                    <div class="col-sm">
                        <label for="updateName">Name</label>
                        <input type="text" class="form-control" id="updateName" name="update_name" placeholder="Enter name">
                    </div>

                    <div class="col-sm">
                        <label for="updatePromptContent">Prompt Content</label>
                        <textarea class="form-control" id="updatePromptContent" name="update_prompt_content" rows="1" placeholder="Enter prompt content"></textarea>
                    </div>

                    <div class="col-sm">
                        <label for="updatePromptVariables">Prompt Variables</label>
                        <input type="text" class="form-control" id="updatePromptVariables" name="update_prompt_variables" placeholder="Enter prompt variables">
                    </div>

                    <div class="col-sm">
                        <label for="updateDesignedFor">Designed For</label>
                        <input type="text" class="form-control" id="updateDesignedFor" name="update_designed_for" placeholder="Enter designed for">
                    </div>

                    <div class="col-sm">
                        <button type="button" class="btn btn-primary" id="updateButton">Update</button>
                    </div>

                </div>
            </div>

            <script>
                //If the field is empty or null, do not update that field
                $(document).ready(function() {
                    $('#updateButton').click(function() {
                        let updateId = $('#updateId').val();

                        //input validation using regex (id can a number between 1 and 999999)
                        if (!/^[1-9]\d{0,5}$/.test(updateId)) {
                            alert("Please enter a valid ID (1-999999)");
                            return;
                        }

                        let updateName = $('#updateName').val();
                        let updatePromptContent = $('#updatePromptContent').val();
                        let updatePromptVariables = $('#updatePromptVariables').val();
                        let updateDesignedFor = $('#updateDesignedFor').val();

                        let formData = {
                            name: updateName,
                            prompt_content: updatePromptContent,
                            prompt_variables: updatePromptVariables,
                            designed_for: updateDesignedFor
                        };

                        if (updateName === "") {
                            delete formData.name;
                        }
                        if (updatePromptContent === "") {
                            delete formData.prompt_content;
                        }
                        if (updatePromptVariables === "") {
                            delete formData.prompt_variables;
                        }
                        if (updateDesignedFor === "") {
                            delete formData.designed_for;
                        }

                        $.ajax({
                            url: '/prompt/' + updateId,
                            type: 'PUT',
                            contentType: 'application/json',
                            data: JSON.stringify(formData),
                            dataType: 'json',
                            success: function(data) {
                                console.log('Success:', data);
                                alert('Prompt updated successfully');
                            },
                            error: function(xhr, status, error) {
                                $('#results').html("Error: " + error);
                            }
                        });
                    });
                });


            </script>


            <!-- Display all prompts in a table -->


            <div class="container">
                <div class="row p-5">
                    <div class="col-sm">
                        <button id="refreshData" class="btn btn-info">Refresh Prompts</button>
                        <div id='results'>

                        </div>
                    </div>
                </div>
            </div>




        </div>

        <script>
            function jsonToHtmlTable(jsonData) {
                // Check if jsonData is empty
                if (jsonData.length === 0) {
                    return "<p>No data available</p>";
                }

                // Start building the table
                let tableHtml = "<table class='table table-hover table-primary table-bordered table-striped'><tr>";

                // Extract headings (keys of the JSON objects)
                Object.keys(jsonData[0]).forEach(key => {
                    tableHtml += `<th>${key}</th>`;
                });
                tableHtml += "</tr>";

                // Populate the table rows with the JSON data
                jsonData.forEach(item => {
                    tableHtml += "<tr>";
                    Object.values(item).forEach(value => {
                        tableHtml += `<td>${value}</td>`;
                    });
                    tableHtml += "</tr>";
                });

                // Close the table tags
                tableHtml += "</table>";

                return tableHtml;
            }


            function getAllPrompts() {
                console.log("Trying to get all prompts");
                $.ajax({
                    url: '/prompt',
                    type: 'GET',
                    success: function(data) {
                        console.log(data);
                        let promptsHtml = jsonToHtmlTable(data)
                        $('#results').html(promptsHtml);
                    },
                    error: function(xhr, status, error) {
                        $('#results').html("Error: " + error);
                    }
                });
            }

            $(document).ready(function() {
                getAllPrompts();
            });

            // Refresh button
            $("#refreshData").click(function() {
                $('#results').html('')
                getAllPrompts();
            });
        </script>
    </body>
</html>